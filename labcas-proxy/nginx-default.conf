## Start %SERVER_HOST% ##

upstream labcas-ui {
    server labcas-ui:8081;
}


upstream labcas-backend {
    server labcas-backend:8080;
}

#Point http requests to https
server {
    listen  80;
    server_name  _;
    return 301 https://$host$request_uri;
    root   /var/www/html;
    index  index.html index.htm;

   
}

map $uri $content_disposition {
    '~^.*/([^/]+)$' 'attachment; filename="$1"';
}

server {
    listen 443 ssl;
    server_name  _;

    access_log  /var/log/nginx/access.log;
    error_log  /var/log/nginx/error.log;
    root   /var/www/html;
    index  index.html index.htm index.rdf;

    ssl_certificate /etc/ssl/certs/server.cer;
    ssl_certificate_key /etc/ssl/private/server.key;

    client_max_body_size 2M;
    large_client_header_buffers 4 8k;
    allow all;


    location = / {
        add_header X-Frame-Options SAMEORIGIN;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
        add_header Strict-Transport-Security "max-age=31536000; includeSubdomains;";
       	return 301 https://$host/labcas-ui;
    }


    location ^~ /labcas-backend/{
        rewrite /labcas-backend/(.*)$ /$1 break;
        proxy_pass  http://labcas-backend/;

        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        proxy_redirect off;
        proxy_buffering off;
        proxy_set_header        Host            $host;
        proxy_set_header        X-Real-IP       $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;

        access_log  /var/log/nginx/labcas-backend.access.log;
        error_log  /var/log/nginx/labcas-backend.error.log;
#        rewrite_log  on;
        add_header X-Frame-Options SAMEORIGIN;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
        add_header Strict-Transport-Security "max-age=31536000; includeSubdomains;";
        add_header Content-Security-Policy "default-src 'self'; object-src 'none'";

   }

    location ^~ /labcas-ui/{
        rewrite /labcas-ui/(.*)$ /labcas-ui/$1 break;
        proxy_pass  http://labcas-ui/;
#        sub_filter "href=\"/" "href=\"${scheme}://${host}/labcas-ui/";
#        sub_filter "src=\"/" "src=\"${scheme}://${host}/sdp/";
#        sub_filter "src=\"./" "src=\"${scheme}://${host}/sdp/";
#        sub_filter "srcset=\"/" "srcset=\"${scheme}://${host}/sdp/";
#        sub_filter "srcset=\"./" "srcset=\"${scheme}://${host}/sdp/";
#        sub_filter_once off;

        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        proxy_redirect off;
        proxy_buffering off;
        proxy_set_header        Host            $host;
        proxy_set_header        X-Real-IP       $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;

        access_log  /var/log/nginx/labcas-ui.access.log;
        error_log  /var/log/nginx/labcas-ui.error.log;
        add_header X-Frame-Options SAMEORIGIN;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
        add_header Strict-Transport-Security "max-age=31536000; includeSubdomains;";
        add_header Content-Security-Policy "default-src 'self'; object-src 'none'; connect-src 'self' *.google-analytics.com *.analytics.google.com *.googletagmanager.com; font-src 'self' fonts.googleapis.com fonts.gstatic.com; style-src 'self' 'unsafe-inline' fonts.googleapis.com www.gstatic.com; script-src 'self' 'unsafe-inline' dap.digitalgov.gov www.google-analytics.com www.gstatic.com *.googletagmanager.com; img-src 'self' *.google-analytics.com *.googletagmanager.com";
        # more_clear_headers Server;
    }

   location /nginx_status {
           # Turn on nginx stats
           stub_status off;
     }

}
